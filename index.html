<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reborn 口语跟读听辨小助手 - 老师端</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333333;
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 40px;
        }
        
        .header {
            background-color: #1F7D78;
            color: #FFFFFF;
            text-align: center;
            padding: 25px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .header h1 {
            font-size: 2.4rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 28px;
            margin-bottom: 30px;
            border: 1px solid #E9ECEF;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #1F7D78;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #F0F4F8;
            font-weight: 600;
        }
        
        .instructions {
            background-color: #FFEEE8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            color: #333333;
        }
        
        .instructions h3 {
            color: #E89880;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 6px;
        }
        
        .input-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .method-tab {
            padding: 12px 24px;
            background-color: #f0f4f8;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
        }
        
        .method-tab.active {
            background-color: #3A91F5;
            color: white;
            border-color: #3A91F5;
        }
        
        .text-input-container {
            margin-bottom: 25px;
        }
        
        .text-input-box {
            width: 100%;
            min-height: 180px;
            padding: 18px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            line-height: 1.6;
            background-color: #F5F9FF;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        .text-input-box:focus {
            outline: none;
            border-color: #3A91F5;
            box-shadow: 0 0 0 3px rgba(58, 145, 245, 0.1);
        }
        
        .word-count {
            text-align: right;
            margin-top: 8px;
            color: #666666;
            font-size: 0.9rem;
        }
        
        .file-upload-container {
            display: none;
            margin-bottom: 25px;
        }
        
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background-color: #F5F9FF;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #3A91F5;
            background-color: #f0f7ff;
        }
        
        .file-upload-area i {
            font-size: 2.5rem;
            color: #3A91F5;
            margin-bottom: 15px;
        }
        
        .file-types {
            color: #666666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background-color: #3A91F5;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-block;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        
        .upload-btn:hover {
            background-color: #2a81e5;
        }
        
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .option-group {
            flex: 1;
            min-width: 200px;
        }
        
        .option-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sentence-preview-container {
            margin-top: 20px;
        }
        
        .sentence-preview-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .sentence-preview-title h3 {
            color: #1F7D78;
            font-size: 1.2rem;
        }
        
        .sentences-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #E9ECEF;
            border-radius: 8px;
            padding: 0;
        }
        
        .sentence-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .sentence-item:last-child {
            border-bottom: none;
        }
        
        .sentence-number {
            background-color: #1F7D78;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .sentence-text {
            flex: 1;
            font-size: 1.05rem;
            line-height: 1.5;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 220px;
        }
        
        .btn-primary {
            background-color: #3A91F5;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2a81e5;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42, 129, 229, 0.2);
        }
        
        .btn-success {
            background-color: #36C768;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2db359;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(54, 199, 104, 0.2);
        }
        
        .btn i {
            font-size: 1.1rem;
        }
        
        .result-container {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background-color: #f9fdf9;
            border-radius: 10px;
            border: 1px solid #d4edda;
        }
        
        .result-title {
            color: #36C768;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-url-box {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .url-text {
            font-family: monospace;
            font-size: 1rem;
            color: #1F7D78;
            word-break: break-all;
            padding-right: 15px;
        }
        
        .copy-btn {
            background-color: #1F7D78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .copy-btn:hover {
            background-color: #166661;
        }
        
        .preview-btn {
            display: inline-block;
            background-color: #3A91F5;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .preview-btn:hover {
            background-color: #2a81e5;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #666666;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-container {
                padding: 15px;
            }
            
            .section {
                padding: 20px;
            }
            
            .input-methods {
                flex-direction: column;
            }
            
            .btn {
                min-width: 100%;
            }
            
            .student-url-box {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .copy-btn {
                align-self: flex-end;
            }
        }
        
        /* 播放测试样式 */
        .play-test-container {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            display: none;
        }
        
        .play-test-title {
            color: #3A91F5;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .test-sentence {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-left: 4px solid #3A91F5;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Reborn 口语跟读听辨小助手</h1>
        <div class="subtitle">天天进步，每日新生</div>
    </div>
    
    <div class="main-container">
        <div class="section">
            <h2 class="section-title">创建口语跟读练习</h2>
            
            <div class="instructions">
                <h3>使用说明</h3>
                <ul>
                    <li>支持直接输入文本或上传文档（txt/word/excel/pdf格式）</li>
                    <li>系统会自动识别英文句子并进行智能断句，确保学生跟读体验</li>
                    <li>生成学生练习页面后，您可以复制链接分享给学生使用</li>
                    <li>在生成链接前，您可以测试语音播放效果</li>
                </ul>
            </div>
            
            <div class="input-methods">
                <div class="method-tab active" id="textTab">直接输入文本</div>
                <div class="method-tab" id="fileTab">上传文档</div>
            </div>
            
            <div id="textInputContainer" class="text-input-container">
                <textarea class="text-input-box" id="textInput" placeholder="请输入或粘贴英文口语练习内容..."></textarea>
                <div class="word-count">单词数: <span id="wordCount">0</span></div>
            </div>
            
            <div id="fileUploadContainer" class="file-upload-container">
                <div class="file-upload-area" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>点击按钮选择文件或拖放文件到此区域</p>
                    <div class="file-types">支持格式: .txt, .doc, .docx, .xls, .xlsx, .pdf</div>
                    <button class="upload-btn" id="fileSelectBtn">选择文件</button>
                    <input type="file" id="fileInput" class="file-input" accept=".txt,.doc,.docx,.xls,.xlsx,.pdf">
                </div>
                <div id="fileInfo" style="display: none; margin-top: 15px; padding: 10px; background-color: #f0f7ff; border-radius: 6px;">
                    <p>已选择文件: <span id="fileName"></span> (<span id="fileSize"></span>)</p>
                </div>
            </div>
            
            <div class="options-container">
                <div class="option-group">
                    <div class="option-title">发音选择</div>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="pronunciation" value="us" checked>
                            标准美式发音
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="pronunciation" value="uk">
                            标准英式发音
                        </label>
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="option-title">断句设置</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="smartSegmentation" checked>
                        <label for="smartSegmentation">启用智能断句（在连词、关系词前合理切分）</label>
                    </div>
                </div>
            </div>
            
            <!-- 播放测试区域 -->
            <div class="play-test-container" id="playTestContainer">
                <div class="play-test-title">语音播放测试</div>
                <div class="test-sentence" id="testSentence">This is a test sentence to check pronunciation.</div>
                <div class="test-buttons">
                    <button class="btn btn-primary" id="testPlayBtn">
                        <i class="fas fa-volume-up"></i> 测试播放
                    </button>
                    <button class="btn btn-secondary" id="testNextBtn">
                        <i class="fas fa-forward"></i> 下一句测试
                    </button>
                </div>
            </div>
            
            <div class="sentence-preview-container" id="sentencePreviewContainer" style="display: none;">
                <div class="sentence-preview-title">
                    <h3>断句预览</h3>
                    <div>共 <span id="sentenceCount">0</span> 句</div>
                </div>
                <div class="sentences-list" id="sentencesList">
                    <!-- 句子预览将在这里动态生成 -->
                </div>
            </div>
            
            <div class="result-container" id="resultContainer">
                <div class="result-title">
                    <i class="fas fa-check-circle"></i> 学生练习页面已生成
                </div>
                <p>学生练习页面已创建成功！您可以复制以下链接分享给学生进行口语跟读练习：</p>
                
                <div class="student-url-box">
                    <div class="url-text" id="studentUrl">https://reborn-speaking-practice.com/student-practice.html?id=</div>
                    <button class="copy-btn" id="copyUrlBtn">
                        <i class="fas fa-copy"></i> 复制链接
                    </button>
                </div>
                
                <p>
                    <a href="#" class="preview-btn" id="previewBtn" target="_blank">
                        <i class="fas fa-external-link-alt"></i> 预览学生练习页面
                    </a>
                </p>
            </div>
        </div>
        
        <!-- 将两个主要按钮移动到页面底部 -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="processBtn">
                <i class="fas fa-cogs"></i> 处理口语练习内容
            </button>
            <button class="btn btn-success" id="generateBtn" disabled>
                <i class="fas fa-link"></i> 生成学生跟读练习链接
            </button>
        </div>
    </div>
    
    <div class="footer">
        Reborn 口语跟读听辨小助手 - 专业语言学习工具
    </div>

    <script>
        // DOM元素
        const textTab = document.getElementById('textTab');
        const fileTab = document.getElementById('fileTab');
        const textInputContainer = document.getElementById('textInputContainer');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const textInput = document.getElementById('textInput');
        const wordCount = document.getElementById('wordCount');
        const fileInput = document.getElementById('fileInput');
        const fileSelectBtn = document.getElementById('fileSelectBtn');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const generateBtn = document.getElementById('generateBtn');
        const sentencePreviewContainer = document.getElementById('sentencePreviewContainer');
        const sentencesList = document.getElementById('sentencesList');
        const sentenceCount = document.getElementById('sentenceCount');
        const resultContainer = document.getElementById('resultContainer');
        const studentUrl = document.getElementById('studentUrl');
        const copyUrlBtn = document.getElementById('copyUrlBtn');
        const previewBtn = document.getElementById('previewBtn');
        const playTestContainer = document.getElementById('playTestContainer');
        const testSentence = document.getElementById('testSentence');
        const testPlayBtn = document.getElementById('testPlayBtn');
        const testNextBtn = document.getElementById('testNextBtn');
        
        // 语音合成API
        let speechSynthesis = window.speechSynthesis;
        let currentSpeech = null;
        
        // 当前数据
        let currentSentences = [];
        let practiceData = {};
        let testSentenceIndex = 0;
        const testSentences = [
            "Good morning, class. Today we're going to practice some useful English expressions.",
            "If you want to ask for help, you can say 'Could you please help me with this?'",
            "When saying goodbye, you can use phrases like 'It was nice talking to you' or 'Have a great day!'",
            "The quick brown fox jumps over the lazy dog. This sentence contains all letters of the alphabet.",
            "Practice makes perfect. Keep repeating these sentences to improve your pronunciation."
        ];
        
        // 标签切换功能
        textTab.addEventListener('click', () => {
            textTab.classList.add('active');
            fileTab.classList.remove('active');
            textInputContainer.style.display = 'block';
            fileUploadContainer.style.display = 'none';
        });
        
        fileTab.addEventListener('click', () => {
            fileTab.classList.add('active');
            textTab.classList.remove('active');
            textInputContainer.style.display = 'none';
            fileUploadContainer.style.display = 'block';
        });
        
        // 单词计数函数
        function updateWordCount() {
            const text = textInput.value.trim();
            const words = text === '' ? 0 : text.split(/\s+/).length;
            wordCount.textContent = words;
        }
        
        // 单词计数
        textInput.addEventListener('input', updateWordCount);
        
        // 文件上传处理
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#3A91F5';
            fileUploadArea.style.backgroundColor = '#f0f7ff';
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.style.borderColor = '#ccc';
            fileUploadArea.style.backgroundColor = '#F5F9FF';
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#ccc';
            fileUploadArea.style.backgroundColor = '#F5F9FF';
            
            if (e.dataTransfer.files.length) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFileSelect(fileInput.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            // 验证文件类型
            const validTypes = ['.txt', '.doc', '.docx', '.xls', '.xlsx', '.pdf'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(fileExt)) {
                alert('不支持的文件格式。请选择以下格式：' + validTypes.join(', '));
                return;
            }
            
            // 显示文件信息
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            // 读取文件内容
            if (fileExt === '.txt') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    textInput.value = e.target.result;
                    updateWordCount();
                };
                reader.readAsText(file);
            } else {
                // 对于其他格式，模拟提取文本内容
                setTimeout(() => {
                    const mockText = `This is a sample text extracted from a ${fileExt.toUpperCase()} file.\n\nYou can use this tool to create speaking practice exercises for your students. The system will automatically split the text into appropriate sentences for students to repeat.\n\nAfter each sentence is played, there will be a pause for the student to repeat it. The student can also navigate between sentences and control the playback.`;
                    textInput.value = mockText;
                    updateWordCount();
                }, 500);
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 语音播放函数
        function speakText(text, voiceType = 'us') {
            // 停止当前语音
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // 创建语音实例
            const utterance = new SpeechSynthesisUtterance(text);
            
            // 设置语音参数
            utterance.rate = 0.9; // 速度
            utterance.pitch = 1.0; // 音调
            utterance.volume = 1.0; // 音量
            
            // 获取可用语音并选择
            const voices = speechSynthesis.getVoices();
            let selectedVoice = null;
            
            if (voiceType === 'us') {
                selectedVoice = voices.find(voice => voice.lang === 'en-US' || voice.lang === 'en-US') || voices.find(voice => voice.lang.startsWith('en'));
            } else if (voiceType === 'uk') {
                selectedVoice = voices.find(voice => voice.lang === 'en-GB') || voices.find(voice => voice.lang.startsWith('en'));
            }
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // 播放语音
            speechSynthesis.speak(utterance);
            
            return utterance;
        }
        
        // 测试播放功能
        testPlayBtn.addEventListener('click', () => {
            const pronunciation = document.querySelector('input[name="pronunciation"]:checked').value;
            currentSpeech = speakText(testSentence.textContent, pronunciation);
            
            testPlayBtn.innerHTML = '<i class="fas fa-volume-up"></i> 播放中...';
            testPlayBtn.disabled = true;
            
            // 监听播放结束
            currentSpeech.onend = () => {
                testPlayBtn.innerHTML = '<i class="fas fa-volume-up"></i> 测试播放';
                testPlayBtn.disabled = false;
            };
        });
        
        // 下一句测试
        testNextBtn.addEventListener('click', () => {
            testSentenceIndex = (testSentenceIndex + 1) % testSentences.length;
            testSentence.textContent = testSentences[testSentenceIndex];
        });
        
        // 智能断句算法
        function smartSentenceSegmentation(text) {
            if (!text.trim()) return [];
            
            // 基础分句：按句号、问号、感叹号分句
            let sentences = text.split(/(?<=[.!?])\s+/);
            let result = [];
            
            // 智能断句规则
            const clauseMarkers = [' and ', ' but ', ' or ', ' so ', ' however ', ' therefore ', ' although ', ' though ', ' because ', ' since ', ' if ', ' when ', ' while ', ' before ', ' after ', ' that ', ' which ', ' who ', ' whom ', ' whose ', ' where ', ' why '];
            
            for (let sentence of sentences) {
                // 如果句子太长（超过120字符），尝试进一步分割
                if (sentence.length > 120) {
                    let subSentences = [sentence];
                    
                    // 首先尝试在连词、关系词前分割
                    for (let marker of clauseMarkers) {
                        let newSubSentences = [];
                        for (let sub of subSentences) {
                            // 查找marker在句子中的位置
                            const regex = new RegExp(`(${marker})`, 'gi');
                            const parts = sub.split(regex);
                            
                            if (parts.length > 1) {
                                // 重组句子，确保marker在第二部分开头
                                let current = '';
                                for (let i = 0; i < parts.length; i++) {
                                    if (clauseMarkers.some(m => parts[i].toLowerCase().includes(m.trim()))) {
                                        if (current.trim()) {
                                            newSubSentences.push(current.trim());
                                            current = parts[i];
                                        } else {
                                            current += parts[i];
                                        }
                                    } else {
                                        current += parts[i];
                                    }
                                }
                                if (current.trim()) {
                                    newSubSentences.push(current.trim());
                                }
                            } else {
                                newSubSentences.push(sub);
                            }
                        }
                        subSentences = newSubSentences;
                    }
                    
                    // 如果还有很长的句子，尝试在逗号处分割
                    let finalSentences = [];
                    for (let sub of subSentences) {
                        if (sub.length > 80 && sub.includes(',')) {
                            // 避免在短的部分分割（少于3个词）
                            const parts = sub.split(/(?<=,)\s+/);
                            let combined = '';
                            
                            for (let part of parts) {
                                if ((combined + part).split(/\s+/).length <= 15) {
                                    combined += (combined ? ' ' : '') + part;
                                } else {
                                    if (combined) finalSentences.push(combined);
                                    combined = part;
                                }
                            }
                            if (combined) finalSentences.push(combined);
                        } else {
                            finalSentences.push(sub);
                        }
                    }
                    
                    result.push(...finalSentences);
                } else {
                    result.push(sentence);
                }
            }
            
            // 清理句子，确保首字母大写，去除多余空格
            return result.map(s => s.trim()).filter(s => s.length > 0);
        }
        
        // 处理口语练习内容
        processBtn.addEventListener('click', () => {
            const text = textInput.value.trim();
            
            if (!text) {
                alert('请输入或上传口语练习内容');
                return;
            }
            
            // 获取选项
            const pronunciation = document.querySelector('input[name="pronunciation"]:checked').value;
            const smartSegmentation = document.getElementById('smartSegmentation').checked;
            
            // 模拟处理过程
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            processBtn.disabled = true;
            
            // 模拟API调用延迟
            setTimeout(() => {
                // 智能断句
                currentSentences = smartSegmentation ? smartSentenceSegmentation(text) : text.split(/(?<=[.!?])\s+/).map(s => s.trim()).filter(s => s.length > 0);
                
                // 显示断句预览
                displaySentencePreview(currentSentences);
                
                // 存储练习数据
                practiceData = {
                    sentences: currentSentences,
                    pronunciation: pronunciation,
                    timestamp: new Date().getTime(),
                    title: text.substring(0, 50) + (text.length > 50 ? '...' : '')
                };
                
                // 启用生成按钮
                generateBtn.disabled = false;
                
                // 显示播放测试区域
                playTestContainer.style.display = 'block';
                
                // 恢复处理按钮
                processBtn.innerHTML = '<i class="fas fa-cogs"></i> 处理口语练习内容';
                processBtn.disabled = false;
                
                // 显示预览区域
                sentencePreviewContainer.style.display = 'block';
                
                // 滚动到测试区域
                playTestContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 800);
        });
        
        // 显示句子预览
        function displaySentencePreview(sentences) {
            sentencesList.innerHTML = '';
            sentenceCount.textContent = sentences.length;
            
            sentences.forEach((sentence, index) => {
                const sentenceItem = document.createElement('div');
                sentenceItem.className = 'sentence-item';
                
                // 添加播放按钮
                const playBtn = document.createElement('button');
                playBtn.className = 'btn btn-primary';
                playBtn.style.padding = '5px 10px';
                playBtn.style.fontSize = '0.8rem';
                playBtn.style.marginLeft = '10px';
                playBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                playBtn.onclick = () => {
                    const pronunciation = document.querySelector('input[name="pronunciation"]:checked').value;
                    speakText(sentence, pronunciation);
                };
                
                sentenceItem.innerHTML = `
                    <div class="sentence-number">${index + 1}</div>
                    <div class="sentence-text">${sentence}</div>
                `;
                
                sentenceItem.querySelector('.sentence-text').appendChild(playBtn);
                sentencesList.appendChild(sentenceItem);
            });
        }
        
        // 生成学生练习链接
        generateBtn.addEventListener('click', () => {
            if (currentSentences.length === 0) {
                alert('请先处理口语练习内容');
                return;
            }
            
            // 模拟生成过程
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            generateBtn.disabled = true;
            
            setTimeout(() => {
                // 生成唯一ID
                const practiceId = 'practice_' + practiceData.timestamp + '_' + Math.random().toString(36).substring(2, 9);
                
                // 将数据编码为Base64，以便在URL中传递
                const encodedData = btoa(encodeURIComponent(JSON.stringify(practiceData)));
                
                // 生成学生练习页面URL
                const currentUrl = window.location.href.split('#')[0];
                const studentPageUrl = `${currentUrl}#student-practice?data=${encodedData}&id=${practiceId}`;
                
                // 显示结果
                studentUrl.textContent = studentPageUrl;
                resultContainer.style.display = 'block';
                
                // 设置预览链接
                previewBtn.href = studentPageUrl;
                
                // 恢复生成按钮
                generateBtn.innerHTML = '<i class="fas fa-link"></i> 生成学生跟读练习链接';
                generateBtn.disabled = false;
                
                // 滚动到结果区域
                resultContainer.scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        });
        
        // 复制链接功能
        copyUrlBtn.addEventListener('click', () => {
            const url = studentUrl.textContent;
            
            // 使用现代剪贴板API
            navigator.clipboard.writeText(url).then(() => {
                // 显示复制成功反馈
                const originalText = copyUrlBtn.innerHTML;
                copyUrlBtn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                
                setTimeout(() => {
                    copyUrlBtn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('复制失败: ', err);
                alert('复制失败，请手动选择并复制链接');
            });
        });
        
        // 检查URL参数，如果是学生端页面则显示学生界面
        function checkUrlForStudentPage() {
            // 检查hash中的参数
            if (window.location.hash.includes('student-practice')) {
                const hashParams = new URLSearchParams(window.location.hash.split('?')[1]);
                const encodedData = hashParams.get('data');
                
                if (encodedData) {
                    try {
                        // 解码Base64数据
                        const decodedData = decodeURIComponent(atob(encodedData));
                        practiceData = JSON.parse(decodedData);
                        
                        // 显示学生端页面
                        showStudentPracticePage();
                        return true;
                    } catch (e) {
                        console.error('解析练习数据失败:', e);
                    }
                }
            }
            
            return false;
        }
        
        // 显示学生练习页面
        function showStudentPracticePage() {
            // 隐藏老师端界面
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.main-container').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            
            if (!practiceData.sentences || practiceData.sentences.length === 0) {
                document.body.innerHTML = `
                    <div style="padding: 50px; text-align: center;">
                        <h2>练习数据错误</h2>
                        <p>抱歉，无法加载口语练习数据。</p>
                        <a href="#" onclick="window.history.back(); return false;">返回</a>
                    </div>
                `;
                return;
            }
            
            // 创建学生端界面
            const studentPageHTML = createStudentPageHTML(practiceData);
            document.body.innerHTML = studentPageHTML;
            
            // 初始化学生端功能
            initializeStudentPage(practiceData);
        }
        
        // 创建学生端页面HTML
        function createStudentPageHTML(practiceData) {
            return `
                <div class="student-header" style="background-color: #36C768; color: white; padding: 20px; text-align: center;">
                    <h1>口语跟读练习</h1>
                    <p style="margin-top: 10px;">老师布置的跟读练习 - 共 ${practiceData.sentences.length} 句</p>
                </div>
                
                <div class="student-container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <div class="practice-info" style="background-color: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h3 style="color: #3A91F5; margin-bottom: 10px;">练习说明</h3>
                        <p>请仔细听每句英文，然后跟读练习。点击播放按钮可以重复播放当前句子。</p>
                        <p>发音: ${practiceData.pronunciation === 'us' ? '标准美式发音' : '标准英式发音'}</p>
                    </div>
                    
                    <div class="current-sentence-container" style="background-color: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px; text-align: center;">
                        <div style="font-size: 1.2rem; color: #666; margin-bottom: 15px;">当前句子 <span id="currentSentenceIndex">1</span> / ${practiceData.sentences.length}</div>
                        <div id="currentSentenceText" style="font-size: 1.8rem; line-height: 1.5; margin-bottom: 25px; min-height: 100px; display: flex; align-items: center; justify-content: center;">${escapeHtml(practiceData.sentences[0])}</div>
                        
                        <div class="playback-controls" style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                            <button id="prevBtn" class="student-btn" style="background-color: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                <i class="fas fa-backward"></i> 上一句
                            </button>
                            <button id="playBtn" class="student-btn" style="background-color: #36C768; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; min-width: 160px;">
                                <i class="fas fa-volume-up"></i> 播放
                            </button>
                            <button id="nextBtn" class="student-btn" style="background-color: #3A91F5; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                下一句 <i class="fas fa-forward"></i>
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button id="repeatBtn" class="student-btn" style="background-color: #ffc107; color: #333; border: none; padding: 10px 20px; border-radius: 6px; font-size: 1rem; cursor: pointer;">
                                <i class="fas fa-redo"></i> 重复播放当前句子
                            </button>
                        </div>
                    </div>
                    
                    <div class="all-sentences" style="background-color: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 30px;">
                        <h3 style="color: #1F7D78; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">所有句子</h3>
                        <div id="allSentencesList" style="max-height: 300px; overflow-y: auto;">
                            ${practiceData.sentences.map((sentence, index) => `
                                <div class="sentence-item" data-index="${index}" style="padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: flex-start; cursor: pointer; transition: background-color 0.2s;">
                                    <div style="background-color: #1F7D78; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; margin-right: 12px;">${index + 1}</div>
                                    <div style="flex: 1;">${escapeHtml(sentence)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="student-actions" style="text-align: center; margin-top: 30px;">
                        <button id="backBtn" class="student-btn" style="background-color: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                            <i class="fas fa-arrow-left"></i> 返回
                        </button>
                    </div>
                </div>
                
                <div class="student-footer" style="text-align: center; margin-top: 40px; color: #666; font-size: 0.9rem; padding: 20px;">
                    Reborn 口语跟读练习 - 学生端
                </div>
            `;
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 初始化学生端页面功能
        function initializeStudentPage(practiceData) {
            const sentences = practiceData.sentences;
            let currentIndex = 0;
            let isPlaying = false;
            
            const currentSentenceText = document.getElementById('currentSentenceText');
            const currentSentenceIndex = document.getElementById('currentSentenceIndex');
            const playBtn = document.getElementById('playBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const repeatBtn = document.getElementById('repeatBtn');
            const backBtn = document.getElementById('backBtn');
            const allSentencesList = document.getElementById('allSentencesList');
            
            // 更新当前句子显示
            function updateCurrentSentence() {
                currentSentenceText.textContent = sentences[currentIndex];
                currentSentenceIndex.textContent = currentIndex + 1;
                
                // 更新列表中的高亮
                document.querySelectorAll('.sentence-item').forEach((item, index) => {
                    if (index === currentIndex) {
                        item.style.backgroundColor = '#f0f7ff';
                        item.style.fontWeight = 'bold';
                    } else {
                        item.style.backgroundColor = '';
                        item.style.fontWeight = 'normal';
                    }
                });
            }
            
            // 播放当前句子
            function playCurrentSentence() {
                if (isPlaying) {
                    speechSynthesis.cancel();
                    isPlaying = false;
                }
                
                const utterance = speakText(sentences[currentIndex], practiceData.pronunciation);
                playBtn.innerHTML = '<i class="fas fa-pause"></i> 播放中...';
                playBtn.style.backgroundColor = '#dc3545';
                isPlaying = true;
                
                utterance.onend = () => {
                    playBtn.innerHTML = '<i class="fas fa-volume-up"></i> 播放';
                    playBtn.style.backgroundColor = '#36C768';
                    isPlaying = false;
                };
            }
            
            // 事件监听器
            playBtn.addEventListener('click', playCurrentSentence);
            
            prevBtn.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateCurrentSentence();
                    if (isPlaying) {
                        speechSynthesis.cancel();
                        isPlaying = false;
                        playBtn.innerHTML = '<i class="fas fa-volume-up"></i> 播放';
                        playBtn.style.backgroundColor = '#36C768';
                    }
                }
            });
            
            nextBtn.addEventListener('click', () => {
                if (currentIndex < sentences.length - 1) {
                    currentIndex++;
                    updateCurrentSentence();
                    if (isPlaying) {
                        speechSynthesis.cancel();
                        isPlaying = false;
                        playBtn.innerHTML = '<i class="fas fa-volume-up"></i> 播放';
                        playBtn.style.backgroundColor = '#36C768';
                    }
                }
            });
            
            repeatBtn.addEventListener('click', playCurrentSentence);
            
            backBtn.addEventListener('click', () => {
                // 清空hash并刷新页面以返回老师端
                window.location.hash = '';
                window.location.reload();
            });
            
            // 点击句子列表中的句子
            allSentencesList.addEventListener('click', (e) => {
                const sentenceItem = e.target.closest('.sentence-item');
                if (sentenceItem) {
                    const index = parseInt(sentenceItem.dataset.index);
                    if (!isNaN(index) && index >= 0 && index < sentences.length) {
                        currentIndex = index;
                        updateCurrentSentence();
                        if (isPlaying) {
                            speechSynthesis.cancel();
                            isPlaying = false;
                            playBtn.innerHTML = '<i class="fas fa-volume-up"></i> 播放';
                            playBtn.style.backgroundColor = '#36C768';
                        }
                    }
                }
            });
            
            // 初始化显示
            updateCurrentSentence();
            
            // 添加学生端样式
            const style = document.createElement('style');
            style.textContent = `
                .student-btn:hover {
                    opacity: 0.9;
                    transform: translateY(-2px);
                    transition: all 0.3s ease;
                }
                
                .sentence-item:hover {
                    background-color: #f8f9fa !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 初始化语音API
        function initSpeechSynthesis() {
            // 等待语音加载完成
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    console.log('语音列表已加载:', speechSynthesis.getVoices().length, '个语音');
                });
            }
        }
        
        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 首先检查是否是学生端页面
            if (!checkUrlForStudentPage()) {
                // 如果不是学生端页面，则显示老师端界面
                // 设置示例文本
                const exampleText = `Good morning, class. Today we're going to practice some useful English expressions that you can use in everyday conversations.\n\nFirst, let's start with greetings. You can say "Hello, how are you?" or "Hi, what's up?" to your friends.\n\nIf you want to ask for help, you can say "Could you please help me with this?" or "I'm having trouble with this, could you give me a hand?"\n\nWhen you're in a store and need assistance, you can say "Excuse me, where can I find the dairy section?" or "Do you have this in a larger size?"\n\nFinally, when saying goodbye, you can use phrases like "It was nice talking to you" or "Have a great day!"`;
                
                textInput.value = exampleText;
                updateWordCount();
                
                // 初始化语音合成
                initSpeechSynthesis();
                
                // 设置初始测试句子
                testSentence.textContent = testSentences[0];
            }
        });
    </script>
</body>
</html>